---
title: "Homework 5"
author: "Ziyu Chen"
date: "11/19/2021"
output: github_document
---
#R setup
```{r message=FALSE}
library(readxl)
library(tidyverse)
```


# Problem 1 

* Read in the data
```{r message=FALSE}
murder_raw = 
  read_csv(url("https://github.com/washingtonpost/data-homicides/raw/master/homicide-data.csv")) 
```

Murder_df has 52179 observations and 12 variables, including city, city_state, disposition, lat, lon, reported_date, state, uid, victim_age, victim_first, victim_last, victim_race, victim_sex. This dataset contains information about homicide cases in the United States. 

* Create the city_state variable,  find the murders count within the city_
```{r}
murder_new = murder_raw %>%
   mutate(city_state = str_c(city, state, sep = ", ")) %>%
  group_by(city_state) %>%
   subset(city_state != "Tulsa, AL")


murder_total=
murder_new %>%
  group_by(city_state) %>%
  summarise(total = n())

murder_unsolved =
  murder_new %>%
  filter(disposition %in% c("Closed without arrest","Open/No arrest")) %>%
  group_by(city_state) %>%
  summarise(unsolved = n())

final = merge(murder_total, murder_unsolved, by = "city_state")
  
  knitr::kable(final [1:10, ]) #showing the only first ten rows to make sure that the data are correct


```

The final table will have information the total and unsolved cases for cities in the US.


* prop.test function on baltimore

```{r}
prop.test(
    x=murder_unsolved %>% 
    filter(city_state == "Baltimore, MD") %>%
    pull(unsolved),
    n=murder_total %>%
    filter(city_state == "Baltimore, MD") %>%
    pull(total)) %>%
  broom::tidy()                


```

* Proportion of unsolved homicides and the confidence interval for each city
```{r}
  final_new = final %>%
  mutate(
    prop = map2(.x = unsolved,               
                .y = total, 
                ~prop.test(x = .x, n = .y)),
    tidy = map(.x = prop,           
               ~broom::tidy(.x))) %>%             
  unnest(tidy) %>%                                       
  select(city_state, estimate, conf.low, conf.high)
  
final_new

```

Make the plot

```{r}
city_plot = 
  final_new %>%
mutate(city_state = fct_reorder(city_state,estimate)) %>%                
  ggplot(aes(x = city_state, y = estimate)) +
  geom_point() + 
  geom_errorbar(aes(ymin = conf.low , ymax = conf.high)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.6, hjust = 1)) +
  ggtitle("Estimates and CIs of Homocides for each city") +
  xlab("City & State") +
  ylab("Estimates") 
city_plot
```


# Problem 2

* Read in the data

```{r}
p2_raw = 
  tibble(file = list.files("./data/"),
         path = str_c("./data/", file)) 
```

* Iterate over file names and read in data for each subject using purrr::map 

```{r message=FALSE}
P2_new =
  p2_raw %>%
  
  mutate(
    data = map(.x = path, ~read_csv(.x)),
    arm = str_remove(path,".csv"),
    arm = str_remove(arm, "./p2data/")) %>%
  separate(arm, c("arm","id"), sep = "_") %>%
  
  mutate(
    arm = ifelse(arm == "con","control","experiment"))%>%
  unnest(data) %>%
  select(-path, -file) %>%
  pivot_longer(
    week_1:week_8,
    values_to = "Observation",
    names_to = "Week") 





  
```






